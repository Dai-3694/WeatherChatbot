#### 1. 背景・目的

- **背景**  
  冬季の新千歳空港（CTS）は悪天候により欠航・遅延・地上交通の混乱が発生しやすい。運用担当者は「翌日の天気と混雑リスク」を早期に把握したいが、複数サイトの確認が手間になっている。
- **目的**  
  気象庁の公開データとカレンダー情報のみを用いて、翌日の空港混雑リスク（低・中・高）を自動推定し、Microsoft Teams にカード形式で通知する。
- **設計方針**
  - 完全無料・API キー不要・ログイン不要
  - 外部依存は気象庁公開データと Teams Webhook のみ
  - GitHub Actions 等でメンテナンス最小の自動運用

---

#### 2. スコープ

- 対象空港：新千歳空港（CTS）
- 対象期間：**翌日 06:00–18:00 の時間帯**における混雑リスク
- 実行タイミング：毎日 **JST 17:00**（GitHub Actions 上では `cron: '0 8 * * *'`）
- 判定ロジック：  
  「**気象リスク × 基礎需要予測（カレンダーベース）**」により 0〜100 スコアを算出し、  
  低・中・高 に区分して表示する。

---

#### 3. 外部アクセス要件

- **禁止事項**
  - Selenium / Playwright 等ブラウザ操作
  - ログインが必要なサイトへのアクセス
  - 有料または API キー取得が煩雑なサービスの利用
- **許可される外部アクセス**
  - 気象庁（JMA）公開 JSON エンドポイント
    - 例：
      - `https://www.jma.go.jp/bosai/forecast/data/forecast/{area_code}.json`
      - `https://www.jma.go.jp/bosai/warning/data/warning/{pref_code}.json`
  - Microsoft Teams Incoming Webhook
  - Python 標準ライブラリ（`datetime`, `json`, `logging` 等）
  - 外部ライブラリ：`requests`, `jpholidays` など無料ライブラリ

---

#### 4. データ仕様

##### 4.1 気象データ

- 取得手段：`requests` による HTTP GET
- 対象エリア：
  - 予報：新千歳空港を含むエリア（一次細分区 or 市町村コード）
  - 警報：北海道（pref_code="01"）の警報 JSON から千歳市相当エリアを抽出
- 取得項目：
  - 翌日 06:00–18:00 における主要な天気テキスト（例：「雪一時曇り」）
  - 降水/降雪の有無（天気テキストに「雪」が含まれるかで判定）
  - 最大風速または風に関するテキスト（可能な範囲で）
  - 警報・注意報の有無と種類（大雪・暴風雪・暴風・風雪等）

- 天気カテゴリへのマッピング：
  - テキストに「暴風雪」「大雪」が含まれる → 「暴風雪」扱い
  - 上記以外で「雪」が含まれる → 「雪」
  - その他（晴れ/曇り/雨など） → 「通常」

##### 4.2 カレンダーデータ

- ライブラリ：`jpholidays` を使用する。
- 判定内容：
  - 曜日：平日 / 金曜 / 土曜 / 日曜
  - 祝日判定：`jpholidays.is_holiday(date)`
  - 連休判定：
    - 「祝日または日曜に隣接する平日」を「連休中日」とみなす
- イベント設定：
  - `config/events.json` に特定イベント期間（さっぽろ雪まつり、年末年始、春節等）を記述。
  - 空の場合はイベント加点 0 とする（= メンテなしでも動作）。

---

#### 5. スコアリングロジック

- 混雑度スコア（0〜100）を以下で定義：

  ```text
  raw_score = (基礎需要点 + イベント加点) × 気象係数
  score = min(100, max(0, raw_score))
  ```

##### 5.1 基礎需要点（Base）

- 平日（月〜木）：30
- 金曜・日曜・月曜：50
- 土曜：40

※月曜が連休明けなどで需要高と仮定して加重。

##### 5.2 イベント加点（Event）

- 連休中日（例：土曜日が祝日–日曜に挟まれる日など）：+20
- 大型イベント期間（雪まつり等）：+30（`events.json` の設定に従う）
- その他イベントは将来的に追加可能。

##### 5.3 気象係数（Weather Multiplier）

1. **天気テキストベース**
   - 通常（晴れ・曇り・雨など）：×1.0
   - 雪（テキストに「雪」含む）：×1.2
   - 暴風雪（テキストに「暴風雪」「大雪」含む）：×1.8

2. **警報・注意報ベース**
   - 大雪警報 / 暴風雪警報 / 暴風警報：最低でも ×1.8 を適用
   - 大雪注意報 / 風雪注意報 / 強風注意報：最低でも ×1.2 を適用
   - 上記を天気テキストによる係数と比較し、**より大きい係数** を採用する。

##### 5.4 スコアからレベルへのマッピング

- 0–39：混雑レベル「低」
- 40–69：混雑レベル「中」
- 70–100：混雑レベル「高」

---

#### 6. Teams 出力仕様

- 投稿方式：Microsoft Teams Incoming Webhook（必須）。
- 環境変数：
  - `TEAMS_WEBHOOK_URL`：Webhook URL。未設定時は実行を中止し、ログに警告を出す。

- Adaptive Card（例：version 1.4）
  - 必須要素：
    - タイトル：「新千歳空港 混雑リスク予測（翌日）」など
    - 対象日（例：YYYY-MM-DD）
    - 混雑レベル（低・中・高）
    - スコア（数値）
    - 予想天気（テキスト）
    - 主なリスク要因（例：「大雪警報」「連休中日」「雪まつり期間」など）
    - 補足コメント（例：  
      「明日は大雪警報の可能性があるため、JR運休リスクを含め混雑レベル『高』と予測されます。」）
    - 参考リンクボタン：
      - 気象庁（天気予報・警報）
      - 新千歳空港公式サイト
      - （任意）交通情報サイトなど公式情報

- エラー時の挙動：
  - 気象庁データ取得失敗・解析失敗時：
    - 「データ取得エラー」メッセージ付きのカードを投稿。
    - スコアは算出しない。

---

#### 7. システム構成・ファイル構造

- 実行環境：
  - GitHub Actions（推奨）またはクラウド Function
  - Python 3.11 を想定
- ディレクトリ構成：

  ```text
  /src
    ├── weather.py   # 気象庁データの取得とパース
    ├── logic.py     # スコア計算・レベル判定
    ├── teams.py     # Adaptive Card 生成と Teams 投稿
    └── main.py      # エントリーポイント
  /config
    ├── events.json   # 特定イベント期間定義（任意）
    └── settings.yaml # 地域コード／スコア閾値／リンクURL 等
  /docs
    └── requirements.md  # 本ファイル
  .github/workflows
    └── run.yml      # 毎日 JST 17:00 に main.py を実行するワークフロー
  ```

- `requirements.txt`：
  - `requests`
  - `jpholidays`
  - 必要に応じて `PyYAML` など

